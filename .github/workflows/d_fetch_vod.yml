name: D-Fetch VOD

on:
  push:
    branches:
      - main

jobs:
  extract-m3u8:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install yt-dlp
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        chmod a+rx /usr/local/bin/yt-dlp

    - name: Fetch latest changes from remote
      run: |
        git fetch origin main
        git pull origin main --no-edit
        git rebase origin/main

    - name: Read live URLs from file
      run: |
        while IFS=, read -r channel_name group live_url; do
          echo "Processing live URL: $live_url"
          
          # Modify the live_url as needed
          modified_url="${live_url/live/streams}"
          
          echo "Modified URL: $modified_url"

          mkdir -p ./vod/$channel_name
          m3u8_file="./vod/$channel_name/vod_videos.m3u8"

          # Truncate the file before writing
          : > "$m3u8_file"

          start_time=$(date +%s)
          attempts=0
          fallback_url_attempt=0
          
          while [ $attempts -lt 3 ]; do
            echo "Attempting to extract video URL (Attempt $((attempts + 1)))..."
            m3u8_url=$(yt-dlp "$modified_url" --get-url --skip-download)
            
            if [ $? -eq 0 ]; then
              echo "Video URL found: $m3u8_url"
              echo $m3u8_url >> "$m3u8_file"
              break
            else
              if [ $fallback_url_attempt -eq 0 ]; then
                echo "First attempt failed. Trying with fallback URL..."
                modified_url="${live_url/live/}"
                fallback_url_attempt=$((fallback_url_attempt + 1))
              else
                echo "Error extracting video URL. Attempt $((attempts + 1)) failed."
                break
              fi
            fi
            
            ((attempts++))
            sleep 2  # Sleep for 2 seconds between attempts
          done

          echo "M3U8 content:"
          cat "$m3u8_file"

          echo "Creating M3U8 file..."
          echo "#EXTM3U" > "./vod/$channel_name/vod_videos_temp.m3u8"
          echo "#EXT-X-VERSION:3" >> "./vod/$channel_name/vod_videos_temp.m3u8"
          video_number=1
          while read -r line; do
            echo "#EXT-X-STREAM-INF:NAME=\"FHD\",RESOLUTION=1920x1080,BANDWIDTH=${video_number}" >> "./vod/$channel_name/vod_videos_temp.m3u8"
            echo "${line}" >> "./vod/$channel_name/vod_videos_temp.m3u8"
            ((video_number++))
          done < "$m3u8_file"

          mv "./vod/$channel_name/vod_videos_temp.m3u8" "$m3u8_file"

          echo "Committing changes..."
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          git add -A
          git diff --cached --quiet || git commit -m "Updated M3U8 files"
          git push origin main
        done < ./program/alt_urls.txt
