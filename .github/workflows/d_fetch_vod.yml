name: Fetch VOD VideoID

on:
  workflow_dispatch:

jobs:
  extract-m3u8:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install yt-dlp and jq
      run: |
        curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
        chmod a+rx /usr/local/bin/yt-dlp
        sudo apt-get install jq

    - name: Fetch latest changes from remote
      run: |
        git fetch origin main
        git pull origin main --no-edit

    - name: Extract channel information
      run: |
        echo "Fetching channel information..."
        while IFS=, read -r channel_name group channel_url; do
          echo "Processing $channel_name from $group group with URL $channel_url/streams"
         video_info=$(yt-dlp -j "$channel_url/streams" --datebefore "$(date -u -d '1 day ago' +"%Y%m%d")" --max-downloads 3 --skip-download --skip-unavailable-fragments --skip-playlist --verbose)

          
          echo "$video_info"  # Display video info for troubleshooting
          
          # Check if the JSON data is not null
          if [ "$video_info" != "null" ]; then
            video_ids=$(echo "$video_info" | jq -r '.entries[] | select(.is_live == false and .start_time == null) | .id')
            
            IFS=',' read -ra video_ids_array <<< "$video_ids"
            for video_id in "${video_ids_array[@]}"; do
              echo "Adding Video ID $video_id to VOD_to_fetch.txt"
              touch VOD_to_fetch.txt
              echo "$video_id, $group, $channel_url" >> VOD_to_fetch.txt
            done
          else
            echo "Error: No video information available for $channel_name."
          fi
        done < current_channels.txt

    - name: Display VOD_to_fetch.txt content
      run: cat VOD_to_fetch.txt

    - name: Commit changes
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git add VOD_to_fetch.txt
        git commit -m "Update VOD_to_fetch.txt"
        git push
